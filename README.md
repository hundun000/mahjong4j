# mahjong4j

基于日麻规则的麻将游戏库。仅包含游戏逻辑，不含UI。

在[源仓库](https://github.com/mahjong4j/mahjong4j)基础上增加了若干功能。[源仓库说明](README-origin.md)

# 新增功能

## 牌桌类

所有属于“牌桌”的组件，由牌桌类管理：牌山，4个游戏中的玩家，当前的dora，当前巡目，牌桌状态……

提供的操作都要符合麻将规则：
- 开始一局游戏
- 当前玩家摸牌
- 当前玩家宣布自摸
- 当前玩家打出牌（并宣布立直）
- 当前玩家暗杠
- 下家玩家吃牌
- 其他玩家碰牌/明杠/荣胡
- ……

## 游戏中的玩家 [GamePlayer类](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/GamePlayer.java)

所有属于“游戏中的玩家”的组件，由游戏中的玩家类管理：Player逻辑，游戏中的玩家状态，是否振听，累计分数……

### GamePlayer成员：状态

[状态枚举](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/PlayerState.java)

当接收到其他玩家出牌事件时，GamePlayer计算自身状态变化（其他玩家出牌事件，可能使得状态从`闲置`变为`待选择是否鸣牌`）。

用于限制所以操作都要符合麻将规则：

- 一巡开始于待摸牌状态，只能进行摸牌操作
- 已摸牌状态下只能进行出牌/暗杠/宣布自摸
- 立直状态下不可换听
- ……

### GamePlayer成员：牌河

管理该玩家的牌河。约束打出的牌必被进入牌河，等。

### GamePlayer成员：鸣牌建议

当接收到其他玩家出牌事件时，GamePlayer计算自身可行的鸣牌建议。可读取用于前端显示。

### GamePlayer成员：行动建议

[行动枚举](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/PlayerActionAdvice.java)

当接收到各类事件时，GamePlayer计算自身可行的行动（例如当鸣牌建议产生后，则行动建议中会存在鸣牌行动；当自身胡牌可行性产生后，则行动建议中会存在胡牌行动；）。可读取用于前端显示。

## GamePlayer成员：舍牌建议

[DiscardAdvice类](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/DiscardAdvice.java)

接收到自身摸牌事件时，GamePlayer计算舍牌建议。

一副可以听牌的手牌（14张），对应若干`DiscardAdvice实例`。即打出某张牌时，听哪些牌，是否振听，分别构成哪些役。

若此时还属于可以立直的情况，则`GamePlayer成员：canReach`为true；若此时还属于振听的情况，则`GamePlayer成员：huriten`为true；

## GamePlayer成员：听牌情况 

[TenpaiCase类](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/TenpaiCase.java)

接收到自身出牌事件时，GamePlayer计算听牌情况。

一副正在听牌的手牌（13张），对应若干`TenpaiCase实例`。即听哪些牌，分别构成哪些役。

## GamePlayer成员：胡牌建议

[WinCase类](https://github.com/hundun000/mahjong4j/blob/feature-for-self/src/main/java/hundun/mahjong4j/extend/game/WinCase.java)

当接收到各类事件时，GamePlayer计算自身是否可以胡牌（包括自摸和荣胡）。

一个检查确实可以胡牌的手牌（14张），对应一个`WinCase实例`。即构成哪些役。

## 可视化工具

将一个牌桌以字符画形式展示。

### 输出示例：

（1） 开局 

```
// 整个牌桌
=======================================
// [玩家0]的手牌
|M|M|M|M|M|M|M|M|M|M|M|M|M|  
|2|2|3|3|4|4|5|5|6|6|7|7|8|  
--------------------------------------
|M|M|P|P|P|P|P|S|S|S|T|H|H|  
|1|7|2|3|5|9|9|3|8|9|O|A|A|  
--------------------------------------
|P|P|P|P|S|S|S|S|S|S|S|H|C|  
|1|3|5|6|1|1|2|4|5|6|8|A|H|  
--------------------------------------
|M|M|P|P|P|P|S|S|S|T|N|S|C|  
|1|2|4|5|7|8|2|7|9|O|A|H|H|  
--------------------------------------
```

（2） [玩家0]摸牌
  
输出内容包括：摸上的牌，可否立直，舍牌提示  

```
=======================================
// [玩家0]摸上M9
|M|M|M|M|M|M|M|M|M|M|M|M|M|  |M|  
|2|2|3|3|4|4|5|5|6|6|7|7|8|  |9|  
// 提示此时可以立直
[advices:(____o____)?
// 舍牌建议：打2M 听3M,6M,9M
|M| !|M|M|M|
|2|  |3|6|9|
|M| !|M|M|M|
|3|  |2|5|8|
|M| !|M|M|
|4|  |2|3|
|M| !|M|M|
|5|  |6|9|
|M| !|M|M|M|
|6|  |2|5|8|
|M| !|M|M|M|M|
|7|  |2|3|5|6|
|M| !|M|
|8|  |9|
|M| !|M|M|M|
|9|  |2|5|8|
]
--------------------------------------
|M|M|P|P|P|P|P|S|S|S|T|H|H|  
|1|7|2|3|5|9|9|3|8|9|O|A|A|  
--------------------------------------
|P|P|P|P|S|S|S|S|S|S|S|H|C|  
|1|3|5|6|1|1|2|4|5|6|8|A|H|  
--------------------------------------
|M|M|P|P|P|P|S|S|S|T|N|S|C|  
|1|2|4|5|7|8|2|7|9|O|A|H|H|  
--------------------------------------
```

（3） [玩家0]打9M+宣布立直+立直通过

```
=======================================
|M|M|M|M|M|M|M|M|M|M|M|M|M|  
|2|2|3|3|4|4|5|5|6|6|7|7|8| 
// 立直中
(____o____)
// 牌河：9M
|M|
|9|
// 听牌中
[tenpai:
// 胡2M时对应的役
|M|タンヤオ 1翻，清一色 6翻，平和 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 10翻 24000点
|2|

|M|清一色 6翻，タンヤオ 1翻，平和 1翻，一盃口 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 11翻 36000点
|5|

|M|タンヤオ 1翻，二盃口 3翻，リーチ 1翻，平和 1翻，清一色 6翻，裏ドラ 1翻，裏ドラ 1翻，合计 30符 14翻 48000点
|8|

]
--------------------------------------
|M|M|P|P|P|P|P|S|S|S|T|H|H|  
|1|7|2|3|5|9|9|3|8|9|O|A|A|  
--------------------------------------
|P|P|P|P|S|S|S|S|S|S|S|H|C|  
|1|3|5|6|1|1|2|4|5|6|8|A|H|  
--------------------------------------
|M|M|P|P|P|P|S|S|S|T|N|S|C|  
|1|2|4|5|7|8|2|7|9|O|A|H|H|  
--------------------------------------
```

（4） [玩家1]摸牌+打3S

```
=======================================
|M|M|M|M|M|M|M|M|M|M|M|M|M|S|  
|2|2|3|3|4|4|5|5|6|6|7|7|8|9|  
(____o____)
|M|
|9|
[tenpai:
|M|タンヤオ 1翻，清一色 6翻，平和 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 10翻 24000点
|2|

|M|清一色 6翻，タンヤオ 1翻，平和 1翻，一盃口 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 11翻 36000点
|5|

|M|タンヤオ 1翻，二盃口 3翻，リーチ 1翻，平和 1翻，清一色 6翻，裏ドラ 1翻，裏ドラ 1翻，合计 30符 14翻 48000点
|8|

]
--------------------------------------
|M|M|P|P|P|P|P|S|S|T|H|H|  |N|  
|1|7|2|3|5|9|9|8|9|O|A|A|  |A|  
// 牌河：3S
|S|
|3|
--------------------------------------
// [玩家2]的鸣牌建议
[chi:
// 可以吃出：345S,234S,123S
|S|S|S| |S|S|S| |S|S|S| 
|3|4|5| |2|3|4| |1|2|3| 
]
|P|P|P|P|S|S|S|S|S|S|S|H|C|  
|1|3|5|6|1|1|2|4|5|6|8|A|H|  
--------------------------------------
|M|M|P|P|P|P|S|S|S|T|N|S|C|  
|1|2|4|5|7|8|2|7|9|O|A|H|H|  
--------------------------------------
```

（5）[玩家2]吃345S+打1P

```
=======================================
|M|M|M|M|M|M|M|M|M|M|M|M|M|S|  
|2|2|3|3|4|4|5|5|6|6|7|7|8|9|  
(____o____)
|M|
|9|
[tenpai:
|M|タンヤオ 1翻，清一色 6翻，平和 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 10翻 24000点
|2|

|M|清一色 6翻，タンヤオ 1翻，平和 1翻，一盃口 1翻，リーチ 1翻，裏ドラ 1翻，合计 32符 11翻 36000点
|5|

|M|タンヤオ 1翻，二盃口 3翻，リーチ 1翻，平和 1翻，清一色 6翻，裏ドラ 1翻，裏ドラ 1翻，合计 30符 14翻 48000点
|8|

]
--------------------------------------
|M|M|P|P|P|P|P|S|S|T|N|H|H|  
|1|7|2|3|5|9|9|8|9|O|A|A|A|  
|S|
|3|
--------------------------------------
// 拥有附露：345S
|P|P|P|S|S|S|S|S|H|C|  |S|S|S| 
|3|5|6|1|1|2|6|8|A|H|  |3|4|5| 
|P|
|1|
--------------------------------------
|M|M|P|P|P|P|S|S|S|T|N|S|C|  
|1|2|4|5|7|8|2|7|9|O|A|H|H|  
--------------------------------------
```